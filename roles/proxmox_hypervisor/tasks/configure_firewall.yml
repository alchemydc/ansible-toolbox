# uses nftables backend which is default in proxmox 8.3+
# needs API token on cluster with sufficient privileges
#
# Correct API Role Privileges
#
# SDN.Allocate: This allows managing the SDN configuration, which includes creating, modifying, and removing firewall rules, IP sets, and aliases.
# SDN.Audit: This allows viewing the SDN configuration, which the Ansible module needs to check the current state (idempotency).
# Sys.Audit: This allows viewing the node's configuration, specifically to check what the current firewall_backend is.
# Sys.Modify: This allows modifying the node's configuration, specifically to set the firewall_backend to nftables.
---
#- name: Apply cluster-wide IP sets via Proxmox API
#  community.proxmox.proxmox_firewall:
#    api_user: "{{ proxmox_api_user | default('root@pam') }}"
#    api_token_id: "{{ proxmox_api_token_id | default(omit) }}"
#    api_token_secret: "{{ proxmox_api_token_secret | default(omit) }}"
#    api_host: "{{ inventory_hostname }}"
#    level: "cluster"
#    state: "present"
#    update: true
#    ip_sets: "{{ pve_cluster_ipsets | default([]) }}"
#  delegate_to: localhost
#  run_once: true
#  become: false
#  tags: "proxmox_firewall"

- name: Apply cluster-wide aliases via Proxmox API
  community.proxmox.proxmox_firewall:
    api_user: "{{ proxmox_api_user | default('root@pam') }}"
    api_token_id: "{{ proxmox_api_token_id | default(omit) }}"
    api_token_secret: "{{ proxmox_api_token_secret | default(omit) }}"
    api_host: "{{ inventory_hostname }}"
    level: "cluster"
    state: "present"
    update: true
    aliases: "{{ pve_cluster_aliases | default([]) }}"
  delegate_to: localhost
  run_once: true
  become: false
  tags: "proxmox_firewall"
  when: pve_cluster_aliases is defined and pve_cluster_aliases | length > 0

- name: Apply cluster-wide filtering rules via Proxmox API
  community.proxmox.proxmox_firewall:
    api_user: "{{ proxmox_api_user | default('root@pam') }}"
    api_token_id: "{{ proxmox_api_token_id | default(omit) }}"
    api_token_secret: "{{ proxmox_api_token_secret | default(omit) }}"
    api_host: "{{ inventory_hostname }}"
    level: "cluster"
    state: "present"
    update: true
    rules: "{{ pve_cluster_rules | default([]) }}"
  delegate_to: localhost
  run_once: true
  become: false
  tags: "proxmox_firewall"

- name: Check if Proxmox Cluster Firewall is enabled
  ansible.builtin.command: "pvesh get /cluster/firewall/options --output-format json"
  register: pve_fw_options
  changed_when: false
  tags: "proxmox_firewall"

- name: Ensure Proxmox Cluster Firewall is ENABLED
  ansible.builtin.command: "pvesh set /cluster/firewall/options --enable 1"
  when: "(pve_fw_options.stdout | from_json).get('enable', 0) != 1"
  register: firewall_enable_result
  changed_when: "'OK' in firewall_enable_result.stdout or firewall_enable_result.rc == 0"
  tags: "proxmox_firewall"

#- name: Deploy nftables NAT rules for Proxmox (ansible-managed)
#  ansible.builtin.template:
#    src: "pve-nat-rules.j2"
#    dest: "/etc/proxmox-firewall/nftables.d/99-ansible-nat.nft"
#    owner: root
#    group: root
#    mode: "0644"
#  notify: "Reload proxmox-firewall"
#  tags: "proxmox_firewall"
