---
# Proxmox kills LXC's that OOM without remorse, which is pretty uncool.
# This task uses any remaining space on the SSD's to create swap partitions
# since swap on ZFS is non-performant.
# Tested on hetzner AX41 and AX51 and AX102 NVME SSD's configured with ZFS as proxmox root, but in theory should work 
# on any Proxmox ZFS/root installs with free space *after* the 3 default partitions (bios boot, EFI, and ZFS)

- name: Read device information for {{ item }}
  parted:
    device: "{{ item }}"
    unit: MiB
  register: swap_device_info

- name: Check if swap partition already exists on {{ item }}
  set_fact:
    has_swap: "{{ swap_device_info.partitions | selectattr('name', 'equalto', 'swap') | list | length > 0 }}"

- name: Debug swap detection for {{ item }}
  debug:
    msg: "Device {{ item }}: Has swap={{ has_swap }}, Partitions={{ swap_device_info.partitions | length }}"
    verbosity: 1

- name: Calculate next partition number for {{ item }}
  set_fact:
    next_part_num: "{{ (swap_device_info.partitions | map(attribute='num') | max) + 1 }}"
    last_part_end: "{{ (swap_device_info.partitions | last).end }}"
  when: not has_swap

- name: Create swap partition on {{ item }}
  parted:
    device: "{{ item }}"
    fs_type: linux-swap
    label: gpt
    name: swap
    number: "{{ next_part_num }}"
    part_end: "100%"
    part_start: "{{ last_part_end | int + 1 }}MiB"
    state: present
  when: not has_swap
  register: partition_created

- name: Determine swap partition path for {{ item }}
  set_fact:
    swap_part_path: "{{ item }}p{{ next_part_num }}"
  when: not has_swap

- name: Create swap filesystem
  filesystem:
    fstype: swap
    dev: "{{ swap_part_path }}"
  when: not has_swap

- name: Get UUID for swap partition
  command: "blkid -s UUID -o value {{ swap_part_path }}"
  register: swap_uuid
  changed_when: false
  when: not has_swap

- name: Add swap partition to /etc/fstab
  lineinfile:
    path: '/etc/fstab'
    line: "UUID={{ swap_uuid.stdout }}   none            swap    sw              0       0"
    state: present
  when: not has_swap

- name: Enable swap partition
  command: "swapon {{ swap_part_path }}"
  when: not has_swap
