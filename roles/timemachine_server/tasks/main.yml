- name: Gather service facts
  ansible.builtin.service_facts:


- name: Update installed packages via APT
  apt:
    upgrade: yes
    update_cache: yes
  become: true

- name: Install Samba via APT
  apt:
    name: samba
    state: present
  become: true

- name: Create time machine directory
  file:
    path: /mnt/timemachine
    state: directory
    owner: root
    group: sambashare
    mode: '0775'
  become: true

- name: Deploy samba smb.conf from template
  template:
    src: smb.conf.j2
    dest: /etc/samba/smb.conf
    owner: root
    group: root
    mode: '0644'
  notify: restart smbd
  become: true

- name: Create samba users
  user:
    name: "{{ item.username }}"
    password: '*'
    state: present
    shell: /bin/false
    createhome: no
    groups:
      - sambashare
  loop: "{{ samba_users }}"
  become: true

- name: Create admin users
  user:
    name: "{{ item.username }}"
    password: "{{ item.password }}"
    state: present
    shell: /bin/bash
    createhome: yes
    home: /home/{{ item.username }}
    groups:
      - sudo
      - adm
    append: yes
  loop: "{{ admin_users }}"
  become: true

- name: Create smbpasswd entries for the users
  shell: "printf '{{ item.samba_password }}\n{{ item.samba_password }}\n' | smbpasswd -s -a {{ item.username }}"
  loop: "{{ samba_users }}"
  become: true

- name: Disable Samba active directory sync service via systemd
  systemd:
    name: samba-ad-dc
    state: stopped
    enabled: no
  become: true


- name: Disable nmbd (NetBIOS disabled)
  ansible.builtin.systemd:
    name: nmbd
    state: stopped
    enabled: no
  when: "'nmbd.service' in ansible_facts.services"
  become: true



- name: Mask Samba AD DC service
  ansible.builtin.systemd:
    name: samba-ad-dc
    masked: yes
  when: "'samba-ad-dc.service' in ansible_facts.services"
  become: true

- name: Ensure smbd enabled and running
  ansible.builtin.systemd:
    name: smbd
    state: started
    enabled: yes
  become: true

- name: Ensure samba-ad-dc package is absent
  ansible.builtin.apt:
    name: samba-ad-dc
    state: absent
  become: true
