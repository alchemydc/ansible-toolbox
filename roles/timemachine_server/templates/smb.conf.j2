# ref: https://www.antoneliasson.se/journal/time-machine-compatible-samba-on-debian-buster/
# ref: https://wiki.samba.org/index.php/Configure_Samba_to_Work_Better_with_Mac_OS_X
# time machine fails now on OSX sequoia, works on previous versions
# ref: https://discussions.apple.com/thread/255762044?sortBy=rank&page=2

# Global Settings
[global]
   workgroup = WORKGROUP
   server string = %h Samba Server
   security = user

   logging = systemd
   log file = /dev/null
   log level = 1 auth_audit:3 auth_json_audit:3

   # do not sync smb passwords with unix passwords
   unix password sync = no
   pam password change = no
   map to guest = Bad User

   # Apple extensions ("AAPL") run under SMB2/3 protocol, make that the minimum (probably shouldn't be running SMB1 anyway...) - defaults to SMB2_2 in Samba 4.11+:
   server min protocol = SMB3_00
   server max protocol = SMB3_11
   disable netbios = yes
   smb ports = 445

   # Enforce authenticated access (avoid guest mapping during Setup Assistant)
   map to guest = Never
   guest account = nobody

   # Apple extensions require support for extended attributes(xattr) - defaults to yes in Samba 4.9+:
   ea support = yes

   # the relevant VFS modules need to be enabled using the vfs objects parameter. fruit is the module that implements the protocol features.
   # It depends on streams_xattr for storing the alternate data streams in extended attributes, so that also needs to be loaded.
   vfs objects = catia fruit streams_xattr acl_xattr
   # store OS X metadata as a stream in a hidden file .DS_Store
   fruit:metadata = stream

   # sets the finder icon
   fruit:model = MacSamba

   # The fruit module needs to be told where to store the alternate data streams. Use 'stream' for better compatibility.
   fruit:resource = stream

   # To tell fruit to reverse the encoding of the aforementioned illegal characters using the catia module, the following parameter must be set:
   fruit:encoding = native

   # Enable server-side copy for performance
   fruit:copyfile = yes

   # Fruit specific file cleanup Settings
   fruit:veto_appledouble = no
   fruit:posix_rename = yes
   fruit:zero_file_id = yes
   fruit:wipe_intentionally_left_blank_rfork = yes
   fruit:delete_empty_adfiles = yes

   # Preserve macOS ACL semantics
   acl_xattr:ignore system acls = yes
   map acl inherit = yes
   inherit acls = yes
   inherit permissions = yes

   # Case-handling preferred by macOS Finder
   case sensitive = false
   preserve case = yes
   short preserve case = yes
   mangled names = no

   # Disable DFS to prevent parse_dfs_path on IP paths
   host msdfs = no

   # Time Machine stability
   posix locking = no
   kernel oplocks = no
   strict locking = no
   oplocks = yes


# Share Configuration for Time Machine
[TimeMachineBackup]
   comment = Time Machine Backup
   path = {{ timemachine_path }}
   valid users = @sambashare
   read only = no
   browseable = yes
   vfs objects = catia fruit streams_xattr acl_xattr
   fruit:time machine = yes
   fruit:time machine max size = {{ timemachine_quota }}
   msdfs root = no
